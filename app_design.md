# 网络应用设计指南

本文档基于[12 factor](https://12factor.net)进行编写，为设计网络应用程序 提供了一种方法。

需要说明的是，本文档是设计的11个条目是以下而上的，前项是后项的基础。

## I. 基准代码 -- 一个代码库对应一个应用
基准代码和应用之间总是保持一一对应的关系.一旦有多个基准代码，就不能称为一个应用，而是一个分布式系统。

尽管每个应用只对应一份基准代码，但可以同时存在多份部署。所有部署的基准代码相同，但每份部署可以使用其不同的版本。

从实际使用上来说，如果使用 git 作为版本管理工具，则一个repository 上只存放一个应用。

## II. 依赖显式声明依赖关系
应用程序不会隐式依赖系统级的类库。 它一定通过依赖清单 ，确切地声明所有依赖项。

建议使用 Maven 进行依赖的管理。

## III. 在环境变量中存储配置 
使用环境变量作为应用的配置有几点好处：

1. 可以非常方便地在不同的部署间做修改，却不动一行代码
2. 与配置文件不同，不小心把它们签入代码库的概率微乎其微
3. 与一些传统的解决配置问题的机制（比如Java的属性配置文件）相比，环境变量与语言和系统无关

注： Spring 和 Play framework 2都支持从 envrionment variables 中读取配置信息。

## IV. 把后端服务当作附加资源

后端服务是指程序运行所需要的通过网络调用的各种服务，如数据库（MySQL，SqlServer），消息/队列系统（RabbitMQ，ActiveMQ）以及缓存系统（Memcached，Redis）。

应用在任意环境中的部署，都应该可以在不进行任何代码改动的情况下，通过配置将本地MySQL数据库换成其它的服务(例如 SqlServer)。类似的，缓存也可以从 Memcached 切换至 Redis。

## V. 构建，发布，运行
应用严格区分构建，发布，运行这三个步骤。每一个发布版本必须对应一个唯一的发布ID，比如可以采用 git 的 commit id 作为发布ID。

当执行构建时，生成一个ID。执行发布任务时需要指定一个发布ID，将对应的构建结果进行发布并运行。

## VI. 应用应不具有状态
应用必须无状态且无共享。任何需要持久化的数据都要存储在后端服务内，比如数据库。Sticky Session是极力反对的。Session中的数据应该保存在诸如Memcached 或 Redis 这样的带有过期时间的缓存中。

## VII. 通过端口绑定来提供服务
应用通过绑定端口来提供服务 ，并监听发送至该端口的请求。

本地环境中，开发人员通过类似http://localhost:8080/的地址来访问服务。在线上环境中，请求统一发送至公共域名而后路由至绑定了端口的应用程序上。

端口绑定这种方式也意味着一个应用可以成为另外一个应用的后端服务 ，调用方将服务方提供的相应 URL 当作资源存入配置以备将来调用。比如，微信的 API，新浪微博的 API 等等。

## VIII. 并发通过进程模型进行扩展
将不同的工作分配给不同的进程类型。例如，HTTP 请求可以交给 web 应用来处理，而常驻的后台工作则交由 worker 应用负责。

此种设计会在系统急需扩展时大放异彩。应用的进程所具备的无共享，水平分区的特性，意味着应用在横向扩展时会很简单和容易。

## IX. 易处理
应该应该可以瞬间开启或停止。这有利于快速、弹性的伸缩应用，迅速部署变化的代码或配置，稳健地部署应用。

进程应当追求最小启动时间；进程一旦接收终止信号(SIGTERM) 就会优雅的终止；进程还应当在面对突然死亡时保持健壮。

## X. 尽可能的保持开发、预发布、线上环境相同
应用想要做到持续部署就必须缩小本地与线上差异。应用的开发人员应该反对在不同环境间使用不同的后端服务 ，比如 QA 环境使用 Mysql 而 PROD 环境使用 SqlServer，即使适配器已经可以几乎消除使用上的差异。

不同的后端服务意味着会突然出现的不兼容，从而导致测试、预发布都正常的代码在线上出现问题。这些错误会给持续部署带来阻力。

注意：不同后端服务的适配器仍然是有用的，因为它们可以使移植后端服务变得简单。但应用的所有部署，这其中包括开发、预发布以及线上环境，都应该使用同一个后端服务的相同版本。

## XI. 把日志当作事件流
应用本身不应该试图去写或者管理日志文件。相反，每一个运行的进程都应直接使用标准输出来输出日志。开发环境中，开发人员可以通过这些数据流，实时在终端看到应用的活动。

在线上环境中，每个进程的输出流由运行环境截获，并与其他输出流整理在一起，一并发送给一个或多个最终的处理程序，用于查看或是长期存档。之后，可以使用工具对日志进行过滤、统计或是报警等。
